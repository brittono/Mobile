!function(t){function e(t,e){return this.settings=t,this.$elem=e,this.mainMenu=null,this.textMenu=null,this.undoArray=[],this.undoCurrent=-1,this.undoMax=10,this.draw=!1,this.canvas=null,this.ctx=null,this.canvasTemp=null,this.ctxTemp=null,this.canvasBg=null,this.ctxBg=null,this.canvasTempLeftOriginal=null,this.canvasTempTopOriginal=null,this.canvasTempLeftNew=null,this.canvasTempTopNew=null,this.textInput=null,this}function n(){return this.menu=null,this}function i(){return this.menu=null,this.docked=!0,this.dockOffsetLeft=0,this.dockOffsetTop=36,this}t.fn.wPaint=function(a,s){if("object"==typeof a)s=a;else if("string"==typeof a){var o=[],l=this.each(function(){var e=t(this).data("_wPaint");e&&("clear"==a?e.clearAll():"image"==a&&void 0===s?o.push(e.getImage()):"image"==a&&void 0!==s?e.setImage(s,!0):"imageBg"==a&&void 0!==s?e.setBgImage(s):void 0!==t.fn.wPaint.defaultSettings[a]&&(void 0!==s?e.settings[a]=s:o.push(e.settings[a])))});return 1===o.length?o[0]:o.length>0?o:l}return s=t.extend({},t.fn.wPaint.defaultSettings,s||{}),s.lineWidthMin=parseInt(s.lineWidthMin),s.lineWidthMax=parseInt(s.lineWidthMax),s.lineWidth=parseInt(s.lineWidth),s.fontSizeMin=parseInt(s.fontSizeMin),s.fontSizeMax=parseInt(s.fontSizeMax),s.fontSize=parseInt(s.fontSize),this.each(function(){var a=t(this),o=jQuery.extend(!0,{},s);if(!document.createElement("canvas").getContext)return a.html("Browser does not support HTML5 canvas, please upgrade to a more modern browser."),!1;if(a.data("_wPaint"))return!1;var l=new e(o,a);l.mainMenu=new n,l.textMenu=new i,o.imageBg&&a.append(l.generateBg(a.width(),a.height(),o.imageBg)),a.append(l.generate(a.width(),a.height())),a.append(l.generateTemp()),a.append(l.generateTextInput()),t("body").append(l.mainMenu.generate(l,l.textMenu)).append(l.textMenu.generate(l,l.mainMenu)),l.mainMenu.moveTextMenu(l.mainMenu,l.textMenu),l.mainMenu.set_mode(l.mainMenu,l,o.mode);var c=t("._wPaint_icon").outerHeight(!0)-(parseInt(t("._wPaint_icon").css("paddingTop").split("px")[0])+parseInt(t("._wPaint_icon").css("paddingBottom").split("px")[0]));l.mainMenu.menu.find("._wPaint_fillColorPicker").wColorPicker({mode:"click",initColor:o.fillStyle,buttonSize:c,showSpeed:300,hideSpeed:300,onSelect:function(t){l.settings.fillStyle=t,l.textInput.css({color:t})}}),l.mainMenu.menu.find("._wPaint_strokeColorPicker").wColorPicker({mode:"click",initColor:o.strokeStyle,buttonSize:c,showSpeed:300,hideSpeed:300,onSelect:function(t){l.settings.strokeStyle=t}}),o.image?l.setImage(o.image,!0):l.addUndo(),a.data("_wPaint",l)})};var a=["Rectangle","Ellipse","Line","Text"];t.fn.wPaint.defaultSettings={mode:"Pencil",lineWidthMin:"0",lineWidthMax:"10",lineWidth:"2",fillStyle:"#FFFFFF",strokeStyle:"#FFFF00",fontSizeMin:"8",fontSizeMax:"20",fontSize:"12",fontFamilyOptions:["Arial","Courier","Times","Trebuchet","Verdana"],fontFamily:"Arial",fontTypeBold:!1,fontTypeItalic:!1,fontTypeUnderline:!1,image:null,imageBg:null,drawDown:null,drawMove:null,drawUp:null,menu:["undo","clear","rectangle","ellipse","line","pencil","text","eraser","fillColor","lineWidth","strokeColor"],menuOffsetX:5,menuOffsetY:5},e.prototype={generate:function(e,n){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d");var i=this;return t(this.canvas).attr("width",e+"px").attr("height",n+"px").css({position:"absolute",left:0,top:0}).mousedown(function(t){t.preventDefault(),t.stopPropagation(),i.draw=!0,i.callFunc(t,i,"Down")}),t(document).mousemove(function(t){i.draw&&i.callFunc(t,i,"Move")}).mouseup(function(t){i.draw&&(i.draw=!1,i.callFunc(t,i,"Up"))}),this.bindMobile(),t(this.canvas)},bindMobile:function(){t(this.canvas).bind("touchstart touchmove touchend touchcancel",function(){var t=event.changedTouches,e=t[0],n="";switch(event.type){case"touchstart":n="mousedown";break;case"touchmove":n="mousemove";break;case"touchend":n="mouseup";break;default:return}var i=document.createEvent("MouseEvent");i.initMouseEvent(n,!0,!0,window,1,e.screenX,e.screenY,e.clientX,e.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(i),event.preventDefault()})},generateTemp:function(){return this.canvasTemp=document.createElement("canvas"),this.ctxTemp=this.canvasTemp.getContext("2d"),t(this.canvasTemp).css({position:"absolute"}).hide(),t(this.canvasTemp)},generateBg:function(e,n,i){return this.canvasBg||(this.canvasBg=document.createElement("canvas"),this.ctxBg=this.canvasBg.getContext("2d"),t(this.canvasBg).attr("id","mofo").css({position:"absolute",left:0,top:0}).attr("width",e).attr("height",n)),this.setBgImage(i),t(this.canvasBg)},generateTextInput:function(){var e=this;return e.textCalc=t("<div></div>").css({display:"none",fontSize:this.settings.fontSize,lineHeight:this.settings.fontSize+"px",fontFamily:this.settings.fontFamily}),e.textInput=t('<textarea class="_wPaint_textInput" spellcheck="false"></textarea>').css({display:"none",position:"absolute",color:this.settings.fillStyle,fontSize:this.settings.fontSize,lineHeight:this.settings.fontSize+"px",fontFamily:this.settings.fontFamily}),e.settings.fontTypeBold&&(e.textInput.css("fontWeight","bold"),e.textCalc.css("fontWeight","bold")),e.settings.fontTypeItalic&&(e.textInput.css("fontStyle","italic"),e.textCalc.css("fontStyle","italic")),e.settings.fontTypeUnderline&&(e.textInput.css("textDecoration","underline"),e.textCalc.css("textDecoration","underline")),t("body").append(e.textCalc),e.textInput},callFunc:function(e,n,i){$e=jQuery.extend(!0,{},e);var s=t(n.canvas).offset();$e.pageX=Math.floor($e.pageX-s.left),$e.pageY=Math.floor($e.pageY-s.top);var o=t.inArray(n.settings.mode,a)>-1?"Shape":n.settings.mode,l=n["draw"+o+i];l&&l($e,n),n.settings["draw"+i]&&n.settings["draw"+i].apply(n,[e,o]),"Text"!==n.settings.mode&&"Up"===i&&this.addUndo()},drawShapeDown:function(e,n){"Text"==n.settings.mode&&(""!=n.textInput.val()&&n.drawTextUp(e,n),n.textInput.css({left:e.pageX-1,top:e.pageY-1,width:0,height:0})),t(n.canvasTemp).css({left:e.pageX,top:e.pageY}).attr("width",0).attr("height",0).show(),n.canvasTempLeftOriginal=e.pageX,n.canvasTempTopOriginal=e.pageY;var i=n["draw"+n.settings.mode+"Down"];i&&i(e,n)},drawShapeMove:function(e,n){var i=n.canvasTempLeftOriginal,a=n.canvasTempTopOriginal,s=n.settings.lineWidth/2,o=(e.pageX<i?e.pageX:i)-("Line"==n.settings.mode?Math.floor(s):0),l=(e.pageY<a?e.pageY:a)-("Line"==n.settings.mode?Math.floor(s):0),c=Math.abs(e.pageX-i)+("Line"==n.settings.mode?n.settings.lineWidth:0),r=Math.abs(e.pageY-a)+("Line"==n.settings.mode?n.settings.lineWidth:0);t(n.canvasTemp).css({left:o,top:l}).attr("width",c).attr("height",r),"Text"==n.settings.mode&&n.textInput.css({left:o-1,top:l-1,width:c,height:r}),n.canvasTempLeftNew=o,n.canvasTempTopNew=l;var d=n["draw"+n.settings.mode+"Move"];if(d){var p="Line"==n.settings.mode?1:2;e.x=s*p,e.y=s*p,e.w=c-n.settings.lineWidth*p,e.h=r-n.settings.lineWidth*p,n.ctxTemp.fillStyle=n.settings.fillStyle,n.ctxTemp.strokeStyle=n.settings.strokeStyle,n.ctxTemp.lineWidth=n.settings.lineWidth*p,d(e,n)}},drawShapeUp:function(e,n){if("Text"!=n.settings.mode){n.ctx.drawImage(n.canvasTemp,n.canvasTempLeftNew,n.canvasTempTopNew),t(n.canvasTemp).hide();var i=n["draw"+n.settings.mode+"Up"];i&&i(e,n)}},drawRectangleMove:function(t,e){e.ctxTemp.beginPath(),e.ctxTemp.rect(t.x,t.y,t.w,t.h),e.ctxTemp.closePath(),e.ctxTemp.stroke(),e.ctxTemp.fill()},drawEllipseMove:function(t,e){var n=t.w/2*.5522848,i=t.h/2*.5522848,a=t.x+t.w,s=t.y+t.h,o=t.x+t.w/2,l=t.y+t.h/2;e.ctxTemp.beginPath(),e.ctxTemp.moveTo(t.x,l),e.ctxTemp.bezierCurveTo(t.x,l-i,o-n,t.y,o,t.y),e.ctxTemp.bezierCurveTo(o+n,t.y,a,l-i,a,l),e.ctxTemp.bezierCurveTo(a,l+i,o+n,s,o,s),e.ctxTemp.bezierCurveTo(o-n,s,t.x,l+i,t.x,l),e.ctxTemp.closePath(),e.settings.lineWidth>0&&e.ctxTemp.stroke(),e.ctxTemp.fill()},drawLineMove:function(t,e){var n=e.canvasTempLeftOriginal,i=e.canvasTempTopOriginal;t.pageX<n&&(t.x=t.x+t.w,t.w=-1*t.w),t.pageY<i&&(t.y=t.y+t.h,t.h=-1*t.h),e.ctxTemp.lineJoin="round",e.ctxTemp.beginPath(),e.ctxTemp.moveTo(t.x,t.y),e.ctxTemp.lineTo(t.x+t.w,t.y+t.h),e.ctxTemp.closePath(),e.ctxTemp.stroke()},drawPencilDown:function(t,e){e.ctx.lineJoin="round",e.ctx.lineCap="round",e.ctx.strokeStyle=e.settings.strokeStyle,e.ctx.fillStyle=e.settings.strokeStyle,e.ctx.lineWidth=e.settings.lineWidth,e.ctx.beginPath(),e.ctx.arc(t.pageX,t.pageY,e.settings.lineWidth/2,0,2*Math.PI,!0),e.ctx.closePath(),e.ctx.fill(),e.ctx.beginPath(),e.ctx.moveTo(t.pageX,t.pageY)},drawPencilMove:function(t,e){e.ctx.lineTo(t.pageX,t.pageY),e.ctx.stroke()},drawPencilUp:function(t,e){e.ctx.closePath()},drawTextDown:function(t,e){e.textInput.val("").show().focus()},drawTextUp:function(t,e){t&&this.addUndo();var n="";e.settings.fontTypeItalic&&(n+="italic "),e.settings.fontTypeBold&&(n+="bold "),n+=e.settings.fontSize+"px "+e.settings.fontFamily;for(var i=e.textInput.val().split("\n"),a=[],s=e.textInput.width()-2,o=0,l=0,c=0,r=i.length;c<r;c++){e.textCalc.html(""),l=0;for(var d=0,p=i[0].length;d<p;d++)(o=e.textCalc.append(i[c][d]).width())>s&&(a.push(i[c].substring(l,d)),l=d,e.textCalc.html(i[c][d]));l!=d&&a.push(i[c].substring(l,d))}i=e.textInput.val(a.join("\n")).val().split("\n");for(var u=e.textInput.position(),h=u.left,g=u.top,c=0,r=i.length;c<r;c++)if(e.ctx.fillStyle=e.settings.fillStyle,e.ctx.textBaseline="top",e.ctx.font=n,e.ctx.fillText(i[c],h,g),g+=e.settings.fontSize,""!=i[c]&&e.settings.fontTypeUnderline){o=e.textCalc.html(i[c]).width();var f=e.ctx.getImageData(0,g+0,o,1);for(d=0;d<f.width*f.height*4;d+=4)f.data[d]=parseInt(e.settings.fillStyle.substring(1,3),16),f.data[d+1]=parseInt(e.settings.fillStyle.substring(3,5),16),f.data[d+2]=parseInt(e.settings.fillStyle.substring(5,7),16),f.data[d+3]=255;e.ctx.putImageData(f,h,g+0)}},drawEraserDown:function(t,e){e.ctx.save(),e.ctx.globalCompositeOperation="destination-out",e.drawPencilDown(t,e)},drawEraserMove:function(t,e){e.drawPencilMove(t,e)},drawEraserUp:function(t,e){e.drawPencilUp(t,e),e.ctx.restore()},getImage:function(){return this.canvasSave=document.createElement("canvas"),this.ctxSave=this.canvasSave.getContext("2d"),t(this.canvasSave).css({display:"none",position:"absolute",left:0,top:0}).attr("width",t(this.canvas).attr("width")).attr("height",t(this.canvas).attr("height")),this.canvasBg&&this.ctxSave.drawImage(this.canvasBg,0,0),this.ctxSave.drawImage(this.canvas,0,0),this.canvasSave.toDataURL()},setImage:function(e,n){var i=this,a=new Image;a.src=e.toString(),i.ctx.clearRect(0,0,i.canvas.width,i.canvas.height),t(a).load(function(){i.ctx.drawImage(a,0,0),n&&i.addUndo()})},setBgImage:function(e,n){var i=this,a=new Image;a.src=e.toString(),i.ctxBg.clearRect(0,0,i.canvasBg.width,i.canvasBg.height),t(a).load(function(){i.ctxBg.drawImage(a,0,0)})},addUndo:function(){for(this.undoCurrent<this.undoArray.length-1?this.undoArray[++this.undoCurrent]=this.getImage():(this.undoArray.push(this.getImage()),this.undoArray.length>this.undoMax?this.undoArray=this.undoArray.slice(1,this.undoArray.length):this.undoCurrent++);this.undoCurrent!=this.undoArray.length-1;)this.undoArray.pop();this.undoToggleIcons()},setUndoImage:function(){this.setImage(this.undoArray[this.undoCurrent])},undoNext:function(){this.undoArray[this.undoCurrent+1]&&(this.undoCurrent++,this.setUndoImage()),this.undoToggleIcons()},undoPrev:function(){this.undoArray[this.undoCurrent-1]&&(this.undoCurrent--,this.setUndoImage()),this.undoToggleIcons()},undoToggleIcons:function(){var t=this.mainMenu.menu.find("._wPaint_undo"),e=this.mainMenu.menu.find("._wPaint_redo");this.undoCurrent>0&&this.undoArray.length>1?t.hasClass("uactive")||t.addClass("uactive"):t.removeClass("uactive"),this.undoCurrent<this.undoArray.length-1?e.hasClass("uactive")||e.addClass("uactive"):e.removeClass("uactive")},clearAll:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.addUndo()}},n.prototype={generate:function(e,n){var i=e;this.textMenu=n;for(var a=this,s="",o=i.settings.lineWidthMin;o<=i.settings.lineWidthMax;o++)s+='<option value="'+o+'" '+(i.settings.lineWidth==o?'selected="selected"':"")+">"+o+"</option>";var l=t('<div class="_wPaint_lineWidth _wPaint_dropDown" title="line width"></div>').append(t("<select>"+s+"</select>").change(function(e){i.settings.lineWidth=parseInt(t(this).val())})),c=t('<div class="_wPaint_options"></div>');t.each(i.settings.menu,function(e,n){switch(n){case"undo":c.append(t('<div class="_wPaint_icon _wPaint_undo" title="undo"></div>').click(function(){i.undoPrev()})).append(t('<div class="_wPaint_icon _wPaint_redo" title="redo"></div>').click(function(){i.undoNext()}));break;case"clear":c.append(t('<div class="_wPaint_icon _wPaint_clear" title="clear"></div>').click(function(){i.clearAll()}));break;case"rectangle":c.append(t('<div class="_wPaint_icon _wPaint_rectangle" title="rectangle"></div>').click(function(){a.set_mode(a,i,"Rectangle")}));break;case"ellipse":c.append(t('<div class="_wPaint_icon _wPaint_ellipse" title="ellipse"></div>').click(function(){a.set_mode(a,i,"Ellipse")}));break;case"line":c.append(t('<div class="_wPaint_icon _wPaint_line" title="line"></div>').click(function(){a.set_mode(a,i,"Line")}));break;case"pencil":c.append(t('<div class="_wPaint_icon _wPaint_pencil" title="pencil"></div>').click(function(){a.set_mode(a,i,"Pencil")}));break;case"text":c.append(t('<div class="_wPaint_icon _wPaint_text" title="text"></div>').click(function(){a.set_mode(a,i,"Text")}));break;case"eraser":c.append(t('<div class="_wPaint_icon _wPaint_eraser" title="eraser"></div>').click(function(t){a.set_mode(a,i,"Eraser")}));break;case"fillColor":c.append(t('<div class="_wPaint_fillColorPicker _wPaint_colorPicker" title="fill color"></div>'));break;case"lineWidth":c.append(l);break;case"strokeColor":c.append(t('<div class="_wPaint_strokeColorPicker _wPaint_colorPicker" title="stroke color"></div>'))}});var r=t('<div class="_wPaint_handle"></div>'),d=t(i.canvas).offset();return this.menu=t('<div class="_wPaint_menu"></div>').css({position:"absolute",left:d.left+i.settings.menuOffsetX,top:d.top+i.settings.menuOffsetY}).draggable({handle:r,drag:function(){a.moveTextMenu(a,a.textMenu)},stop:function(){a.moveTextMenu(a,a.textMenu)}}).append(r).append(c)},moveTextMenu:function(t,e){e.docked&&e.menu.css({left:parseInt(t.menu.css("left"))+e.dockOffsetLeft,top:parseInt(t.menu.css("top"))+e.dockOffsetTop})},set_mode:function(t,e,n){e.settings.mode=n,"Text"==n?t.textMenu.menu.show():(e.drawTextUp(null,e),t.textMenu.menu.hide(),e.textInput.hide()),t.menu.find("._wPaint_icon").removeClass("active"),t.menu.find("._wPaint_"+n.toLowerCase()).addClass("active")}},i.prototype={generate:function(e,n){for(var i=e,a=this,s="",o=i.settings.fontSizeMin;o<=i.settings.fontSizeMax;o++)s+='<option value="'+o+'" '+(i.settings.fontSize==o?'selected="selected"':"")+">"+o+"</option>";for(var l=t('<div class="_wPaint_fontSize _wPaint_dropDown" title="font size"></div>').append(t("<select>"+s+"</select>").change(function(e){var n=parseInt(t(this).val());i.settings.fontSize=n,i.textInput.css({fontSize:n,lineHeight:n+"px"}),i.textCalc.css({fontSize:n,lineHeight:n+"px"})})),s="",o=0,c=i.settings.fontFamilyOptions.length;o<c;o++)s+='<option value="'+i.settings.fontFamilyOptions[o]+'" '+(i.settings.fontFamily==i.settings.fontFamilyOptions[o]?'selected="selected"':"")+">"+i.settings.fontFamilyOptions[o]+"</option>";var r=t('<div class="_wPaint_fontFamily _wPaint_dropDown" title="font family"></div>').append(t("<select>"+s+"</select>").change(function(e){var n=t(this).val();i.settings.fontFamily=n,i.textInput.css({fontFamily:n}),i.textCalc.css({fontFamily:n})})),d=t('<div class="_wPaint_options"></div>').append(t('<div class="_wPaint_icon _wPaint_bold '+(i.settings.fontTypeBold?"active":"")+'" title="bold"></div>').click(function(){a.setType(a,i,"Bold")})).append(t('<div class="_wPaint_icon _wPaint_italic '+(i.settings.fontTypeItalic?"active":"")+'" title="italic"></div>').click(function(){a.setType(a,i,"Italic")})).append(t('<div class="_wPaint_icon _wPaint_underline '+(i.settings.fontTypeUnderline?"active":"")+'" title="underline"></div>').click(function(){a.setType(a,i,"Underline")})).append(l).append(r),p=t('<div class="_wPaint_handle"></div>');t(i.canvas).offset();return this.menu=t('<div class="_wPaint_menu"></div>').css({display:"none",position:"absolute"}).draggable({snap:"._wPaint_menu",handle:p,stop:function(){t.each(t(this).data("draggable").snapElements,function(t,e){a.dockOffsetLeft=a.menu.offset().left-n.menu.offset().left,a.dockOffsetTop=a.menu.offset().top-n.menu.offset().top,a.docked=e.snapping})}}).append(p).append(d)},setType:function(t,e,n){var i=t.menu.find("._wPaint_"+n.toLowerCase()),a=i.hasClass("active");e.settings["fontType"+n]=!a,a?i.removeClass("active"):i.addClass("active"),fontTypeBold=e.settings.fontTypeBold?"bold":"normal",fontTypeItalic=e.settings.fontTypeItalic?"italic":"normal",fontTypeUnderline=e.settings.fontTypeUnderline?"underline":"none",e.textInput.css({fontWeight:fontTypeBold}),e.textCalc.css({fontWeight:fontTypeBold}),e.textInput.css({fontStyle:fontTypeItalic}),e.textCalc.css({fontStyle:fontTypeItalic}),e.textInput.css({textDecoration:fontTypeUnderline}),e.textCalc.css({textDecoration:fontTypeUnderline})}}}(jQuery);
//# sourceMappingURL=wPaint.min.js.map
